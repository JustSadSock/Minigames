<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <meta name="theme-color" content="#0d0f17" id="themeColor">
  <title>DeepFly ‚Äî –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã</title>
  <!--
    –≠—Ç–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–≥—Ä–æ–≤–æ–≥–æ —Ö–∞–±–∞.  –û–Ω–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–±–æ—Ä–∫–∏ –∏–ª–∏ –≤–Ω–µ—à–Ω–∏—Ö
    –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.  –û—Å–Ω–æ–≤–Ω–∞—è
    –ª–æ–≥–∏–∫–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞ –≤–Ω–∏–∑—É –≤ –≤–∏–¥–µ ES‚Äë–º–æ–¥—É–ª—è.  –ò–≥—Ä—ã –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É –≤–∏–¥–∞ #game=&lt;slug&gt; –∏ —Ä–∞—Å–ø–æ–ª–∞–≥–∞—é—Ç—Å—è –≤ –ø–∞–ø–∫–µ games/.
  -->
  <style>
    :root{
      /* –ë–∞–∑–æ–≤–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞.  –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–µ–≥–∫–æ
         –ø–µ—Ä–µ–∫—Ä–∞—à–∏–≤–∞—é—Ç—Å—è ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∑–¥–µ—Å—å. */
      --bg:#0d0f17;
      --panel:#111422;
      --grid-even:#1a1d2c;
      --grid-odd:#171a29;
      --border:#1b1e2e;
      --highlight:#272a3b;
      --ink:#d7defd;
      --muted:#8c92b8;
      --p1:#ff5ca8;
      --p2:#68c7ff;
      --radius:12px;
      --shadow:0 8px 24px rgba(0,0,0,.35);
    }

    html,body{height:100%;margin:0;color:var(--ink);background:var(--bg);
      font-family:ui-monospace,SFMono-Regular,Consolas,"Liberation Mono",monospace;
      overscroll-behavior:none;}
    *{box-sizing:border-box;}
    body{display:flex;flex-direction:column;overflow:hidden;touch-action:manipulation;}
    header,footer{
      padding:8px 16px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      color:var(--ink);
      display:flex;align-items:center;gap:16px;
    }
    header h1{margin:0;font-size:16px;font-weight:700;letter-spacing:.5px;}
    header .spacer{flex:1;}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    /* –ö–Ω–æ–ø–∫–∏ —Å —á–µ—Ç—ã—Ä—å–º—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏: idle, hover, active, disabled */
    .btn{
      --bg1: #222642;
      --bg2: #191c30;
      --border1: #2a2e49;
      --border2: #191c30;
      --text: #e6ebff;
      appearance:none;border:0;cursor:pointer;
      padding:6px 10px;font-weight:700;font-size:12px;border-radius:10px;
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      box-shadow: inset 0 -2px 0 0 rgba(0,0,0,.4), 0 6px 0 0 rgba(0,0,0,.2), 0 10px 16px rgba(0,0,0,.3);
      transition: transform .05s ease, filter .15s ease;
      position:relative;
      min-width:44px;min-height:44px;touch-action:manipulation;
    }
    .btn::after{
      content:""; position:absolute; inset:0;border-radius:10px;
      box-shadow: inset 0 0 0 1px var(--border1), inset 0 0 0 2px var(--border2);
      pointer-events:none;
    }
    .btn:hover{filter:saturate(1.3);}
    .btn:active{transform:translateY(2px); box-shadow: inset 0 -1px 0 0 rgba(0,0,0,.45), 0 4px 0 0 rgba(0,0,0,.2), 0 8px 12px rgba(0,0,0,.3);}
    .btn[disabled]{opacity:.5;cursor:not-allowed;filter:grayscale(.6) saturate(.5);}
    .btn:focus{outline:2px solid var(--highlight);outline-offset:2px;}
    .p1{--bg1:#ff6bb5;--bg2:#c43e7a;--text:#fff;}
    .p2{--bg1:#7ad6ff;--bg2:#2a97d8;--text:#fff;}
    .ghost{--bg1:#1a1d31;--bg2:#0f1223;--text:#aeb6e9;}

    main{flex:1;display:grid;grid-template-columns:1fr minmax(260px,72vh) 1fr;gap:16px;padding:16px;align-items:flex-start;}
    .side{display:grid;gap:16px;max-width:380px;width:100%;}
    .center{display:grid;gap:16px;}
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      box-shadow:var(--shadow);
    }
    .avatar{display:grid;grid-template-columns:auto 1fr;gap:12px;align-items:center;}
    .avatar .name{font-weight:700;color:#e9edff;font-size:14px;margin-bottom:4px;}
    .avatar .stats{font-size:12px;color:var(--muted);}    
    .pixel{image-rendering: pixelated; image-rendering: crisp-edges;}
    /* –°—Ü–µ–Ω–∞-–ø—Ä–µ–≤—å—é */
    .scene{
      position:relative;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;aspect-ratio:1/1;
    }
    .scene canvas{border-radius:var(--radius);}
    /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–µ–Ω—é –∏–≥—Ä */
    .vlist{display:grid;gap:12px;overflow-y:auto;padding:8px;max-height:calc(100vh - 180px);}
    .vcard{appearance:none;border:1px solid var(--border);border-radius:var(--radius);background:var(--panel);color:var(--ink);cursor:pointer;display:grid;grid-template-columns:auto 1fr;align-items:center;gap:12px;padding:10px;min-height:64px;text-align:left;touch-action:manipulation;}
    .vcard:hover{filter:saturate(1.1);}
    .vcard:active{transform:translateY(2px);}
    .vcard:focus{outline:2px solid var(--highlight);outline-offset:2px;}
    .icon64{width:64px;height:64px;image-rendering:pixelated;}
    .meta .title{font-weight:700;}
    .meta .caption{font-size:12px;color:var(--muted);}
    .hud{display:flex;justify-content:space-between;gap:8px;font-size:12px;color:var(--muted);}
    .tag{padding:4px 8px;border-radius:999px;background:#14172a;border:1px solid #232742;}
    @media(max-width:860px){
      main{grid-template-columns:1fr;grid-template-rows:auto auto auto;max-width:720px;margin:0 auto;}
      .side{max-width:none;}
    }

    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .dialog{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);position:relative;min-width:280px;}
    .hidden{display:none;}
  </style>
</head>
<body>
  <header>
    <h1>DeepFly ‚Äî –º–∏–Ω–∏‚Äë–∏–≥—Ä—ã</h1>
    <div class="spacer"></div>
    <div class="row">
      <canvas id="btnGames" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
      <canvas id="btnSettings" class="pixel" width="80" height="20" style="width:80px;height:20px;"></canvas>
      <canvas id="btnAvatar" class="pixel" width="80" height="20" style="width:80px;height:20px;"></canvas>
    </div>
  </header>

  <main>
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ø—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section class="side">
      <div class="panel avatar">
        <canvas id="avatar1" class="pixel" width="64" height="64" style="width:64px;height:64px;"></canvas>
        <div>
          <div class="name" id="playerName">–ò–≥—Ä–æ–∫</div>
          <div class="stats" id="playerStats">–≥–æ—Ç–æ–≤ ‚Ä¢ ‚ô• 3 ‚Ä¢ ‚òÖ 0</div>
          <div class="row" style="margin-top:8px">
            <canvas id="profileSave" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
            <canvas id="profileReset" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
          </div>
        </div>
      </div>
    </section>
    <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å—Ü–µ–Ω–∞ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–µ–Ω—é –∏–≥—Ä -->
    <section class="center">
      <div class="scene panel" id="scenePanel">
        <canvas id="preview" class="pixel" width="192" height="192"></canvas>
      </div>
      <div id="vmenu" class="panel vlist" role="list"></div>
    </section>
    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ HUD -->
    <section class="side">
      <div class="panel avatar">
        <canvas id="avatar2" class="pixel" width="64" height="64" style="width:64px;height:64px;"></canvas>
        <div>
          <div class="name" id="player2Name">–ì–æ—Å—Ç—å</div>
          <div class="stats" id="player2Stats">–≤ —Å–µ—Ç–∏ ‚Ä¢ ‚ô• 3 ‚Ä¢ ‚òÖ 0</div>
          <div class="row" style="margin-top:8px">
            <canvas id="inviteBtn" class="pixel" width="80" height="20" style="width:80px;height:20px;"></canvas>
            <canvas id="skinBtn" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
          </div>
        </div>
      </div>
      <div class="panel hud">
        <span class="tag">v1.0.0</span>
        <span class="fps" id="fps">FPS¬†‚Äì</span>
      </div>
    </section>
  </main>
  <footer>
    <small style="color:var(--muted)">–ù–∞–≤–∏–≥–∞—Ü–∏—è: –≤—ã–±–∏—Ä–∞–π—Ç–µ –∏–≥—Ä—É –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö—ç—à <code>#game=&lt;slug&gt;</code> –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ.</small>
  </footer>

  <div id="settingsDialog" class="backdrop hidden">
    <div id="settingsPanel" class="dialog" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <canvas id="settingsClose" class="pixel" width="16" height="16" style="position:absolute;top:8px;right:8px;width:16px;height:16px;"></canvas>
      <h2 id="settingsTitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
      <label><input type="checkbox" id="muteToggle"> –ó–≤—É–∫</label><br>
      <label><input type="checkbox" id="vfxToggle"> –≠—Ñ—Ñ–µ–∫—Ç—ã</label><br>
      <label><input type="checkbox" id="themeAltToggle"> –ê–ª—å—Ç. —Ç–µ–º–∞</label><br>
      <div class="row" style="margin-top:8px;">
        <canvas id="settingsSave" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
        <canvas id="settingsCancel" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
      </div>
    </div>
  </div>

  <div id="avatarDialog" class="backdrop hidden">
    <div id="avatarPanel" class="dialog" role="dialog" aria-modal="true" aria-labelledby="avatarTitle">
      <canvas id="avatarClose" class="pixel" width="16" height="16" style="position:absolute;top:8px;right:8px;width:16px;height:16px;"></canvas>
      <h2 id="avatarTitle">–ü—Ä–æ—Ñ–∏–ª—å</h2>
      <input id="nickInput" placeholder="–ù–∏–∫–Ω–µ–π–º" style="font-size:16px;padding:4px;width:100%;margin-bottom:8px;" />
      <canvas id="avatarEdit" class="pixel" width="64" height="64" style="width:64px;height:64px;margin-bottom:8px;"></canvas>
      <div class="row" id="avatarControls" style="gap:6px;flex-wrap:wrap">
        <div><small>–ü—Ä–∏—á–µ—Å–∫–∞</small><br>
          <canvas id="hairPrev" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
          <canvas id="hairNext" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
        </div>
        <div><small>–ì–ª–∞–∑–∞</small><br>
          <canvas id="eyesPrev" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
          <canvas id="eyesNext" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
        </div>
        <div><small>–†–æ—Ç</small><br>
          <canvas id="mouthPrev" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
          <canvas id="mouthNext" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
        </div>
        <div><small>–¶–≤–µ—Ç –≤–æ–ª–æ—Å</small><br>
          <canvas id="colorPrev" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
          <canvas id="colorNext" class="pixel" width="32" height="16" style="width:32px;height:16px;"></canvas>
        </div>
      </div>
      <div class="row" style="margin-top:8px;">
        <canvas id="avatarSave" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
        <canvas id="avatarCancel" class="pixel" width="64" height="20" style="width:64px;height:20px;"></canvas>
      </div>
    </div>
  </div>

  <script type="module">
  /*
    –ë–∞–∑–æ–≤—ã–π SPA‚Äë—Ö–∞–±: —Ä–∏—Å—É–µ—Ç –ø—Ä–µ–≤—å—é (—Å–µ—Ç–∫—É, –∫—É—Ä—Å–æ—Ä, —á–∞—Å—Ç–∏—Ü—ã), —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–º–æ–π,
    —Ö—Ä–∞–Ω–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∏–≥—Ä–æ–≤—ã–µ –º–æ–¥—É–ª–∏ –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç.
    –ö–∞–∂–¥–∞—è –∏–≥—Ä–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç manifest + mount/unmount, –∂–∏–≤—ë—Ç –≤ games/<slug>/.
  */
  const HUB_VERSION = '1.0.0';

  const $ = (sel) => document.querySelector(sel);

  // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–∞–Ω–≤–∞—Å-–∫–Ω–æ–ø–∫–∞
  function makeCanvasButton(canvas, { label, onClick, fontPx=10, width=canvas.width, height=canvas.height }){
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    canvas.width = width; canvas.height = height;
    let st = 0; let enabled = true;
    function draw(){
      const bg = ['#1a1d31','#232742','#0f1223'][st];
      ctx.clearRect(0,0,width,height);
      ctx.fillStyle = bg; ctx.fillRect(0,0,width,height);
      ctx.strokeStyle = '#000'; ctx.strokeRect(0.5,0.5,width-1,height-1);
      ctx.fillStyle = enabled ? '#e6ebff' : '#8c92b8';
      ctx.font = `${fontPx}px ui-monospace`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(label, width/2, height/2+1);
    }
    function setEnabled(v){ enabled = !!v; draw(); }
    function setLabel(v){ label = v; canvas.setAttribute('aria-label', v); draw(); }
    canvas.tabIndex = 0; canvas.setAttribute('role','button'); canvas.setAttribute('aria-label', label);
    canvas.addEventListener('pointerenter',()=>{ if(enabled){ st=1; draw(); } });
    canvas.addEventListener('pointerleave',()=>{ if(enabled){ st=0; draw(); } });
    canvas.addEventListener('pointerdown',e=>{ if(enabled){ e.preventDefault(); st=2; draw(); } });
    canvas.addEventListener('pointerup',()=>{ if(enabled){ st=1; draw(); onClick && onClick(); } });
    canvas.addEventListener('keydown',e=>{ if(enabled && (e.key==='Enter'||e.key===' ')){ onClick && onClick(); } });
    draw();
    return { setEnabled, setLabel };
  }

  // –ü—Ä–æ—Å—Ç–∞—è —Ç–µ–º–∞: dark –∏ alternative
  const theme = {
    current: 'dark',
    apply(name){
      theme.current = name;
      if(name === 'alt'){
        document.documentElement.style.setProperty('--bg','#141b2e');
        document.documentElement.style.setProperty('--panel','#1c233c');
        document.documentElement.style.setProperty('--grid-even','#202745');
        document.documentElement.style.setProperty('--grid-odd','#1d2341');
        document.documentElement.style.setProperty('--border','#252e50');
        document.documentElement.style.setProperty('--ink','#ccd9ff');
        document.documentElement.style.setProperty('--muted','#8fa1c7');
      } else {
        document.documentElement.style.setProperty('--bg','#0d0f17');
        document.documentElement.style.setProperty('--panel','#111422');
        document.documentElement.style.setProperty('--grid-even','#1a1d2c');
        document.documentElement.style.setProperty('--grid-odd','#171a29');
        document.documentElement.style.setProperty('--border','#1b1e2e');
        document.documentElement.style.setProperty('--ink','#d7defd');
        document.documentElement.style.setProperty('--muted','#8c92b8');
      }
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      document.getElementById('themeColor').setAttribute('content', bg);
    },
    toggle(){ const next = theme.current==='dark' ? 'alt' : 'dark'; theme.apply(next); return next; }
  };

  // –ü—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–π —à–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π
  const bus = new EventTarget();

  // —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫/–ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (IndexedDB –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
  const store = {
    prefix:'deepfly.',
    get(key, def){ try{ const v = localStorage.getItem(this.prefix+key); return v ? JSON.parse(v) : def; }catch(_){ return def; } },
    set(key,val){ localStorage.setItem(this.prefix+key, JSON.stringify(val)); },
    del(key){ localStorage.removeItem(this.prefix+key); }
  };

  const settings = { mute:false, vfx:true, theme:'dark' };

  // –ú–∏–Ω–∏‚Äë—Ç–æ—Å—Ç
  function flash(text){
    const el = document.createElement('div');
    el.textContent = text;
    el.style.cssText = `position:fixed;left:50%;top:20px;transform:translateX(-50%);background:#1e2244;border:1px solid #2c325a;color:#e6ebff;padding:8px 12px;border-radius:10px;box-shadow:${getComputedStyle(document.documentElement).getPropertyValue('--shadow')};font-size:12px;z-index:999;opacity:0;transition:opacity .2s ease`;
    document.body.appendChild(el);
    requestAnimationFrame(()=>{ el.style.opacity='1'; });
    setTimeout(()=>{ el.style.opacity='0'; }, 2200);
    setTimeout(()=>{ el.remove(); }, 2600);
  }

  function openDialog(sel, opener){
    const wrap = typeof sel==='string'?$(sel):sel;
    const prev = opener || document.activeElement;
    wrap.classList.remove('hidden');
    const focusable = Array.from(wrap.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(el=>!el.disabled);
    const first = focusable[0];
    const last = focusable[focusable.length-1];
    if(first) first.focus();
    const inertEls = Array.from(document.body.children).filter(el=>el!==wrap);
    inertEls.forEach(el=>el.inert=true);
    function onKey(e){
      if(e.key==='Escape'){ close(); }
      else if(e.key==='Tab'){
        if(focusable.length===0){ e.preventDefault(); return; }
        if(e.shiftKey){
          if(document.activeElement===first){ last.focus(); e.preventDefault(); }
        }else{
          if(document.activeElement===last){ first.focus(); e.preventDefault(); }
        }
      }
    }
    function onClick(e){ if(e.target===wrap){ close(); } }
    function close(){
      wrap.classList.add('hidden');
      document.removeEventListener('keydown',onKey);
      wrap.removeEventListener('click',onClick);
      inertEls.forEach(el=>el.inert=false);
      prev && prev.focus();
    }
    document.addEventListener('keydown',onKey);
    wrap.addEventListener('click',onClick);
    return { close };
  }

  // –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –º–∏–Ω–∏‚Äë–ø—Ä–µ–≤—å—é –Ω–∞ –≥–ª–∞–≤–Ω–æ–π (—Å–µ—Ç–æ—á–Ω–∞—è –∞—Ä–µ–Ω–∞, –∫—É—Ä—Å–æ—Ä—ã, —á–∞—Å—Ç–∏—Ü—ã)
  const previewCanvas = $('#preview');
  const pctx = previewCanvas.getContext('2d', { alpha:false });
  pctx.imageSmoothingEnabled = false;
  function fitCanvas(canvas, panel){
    const ro = new ResizeObserver(()=>{
      const w = panel.clientWidth; const h = panel.clientHeight;
      const scale = Math.max(1, Math.floor(Math.min(w/canvas.width, h/canvas.height)));
      canvas.style.width = canvas.width*scale+'px';
      canvas.style.height = canvas.height*scale+'px';
    });
    ro.observe(panel); return ro;
  }
  const previewRO = fitCanvas(previewCanvas, $('#scenePanel'));
  const PREVIEW_W = 192, PREVIEW_H = 192;
  const GRID = 12;
  const previewState = {
    t:0,
    cursors:[
      { x: Math.floor(GRID*0.7), y: Math.floor(GRID*0.4), frame:0, color: '#ff77bd' },
      { x: Math.floor(GRID*0.3), y: Math.floor(GRID*0.7), frame:0, color: '#68c7ff' }
    ],
    particles:[]
  };
  function rnd(n){ return Math.random()*n; }
  function spawn(x,y,color){
    if(!settings.vfx) return;
    for(let i=0;i<5;i++){
      previewState.particles.push({ x, y, vx:(Math.random()-.5)*.6, vy:(Math.random()-.5)*.6 - .2, life:20+Math.random()*20, age:0, color });
    }
  }
  previewCanvas.addEventListener('pointerdown', e=>{
    const rect = previewCanvas.getBoundingClientRect();
    const sx = (e.clientX-rect.left)/rect.width;
    const sy = (e.clientY-rect.top)/rect.height;
    const gx = Math.max(0, Math.min(GRID-1, Math.floor(sx*GRID)));
    const gy = Math.max(0, Math.min(GRID-1, Math.floor(sy*GRID)));
    previewState.cursors[0].x = gx; previewState.cursors[0].y = gy; previewState.cursors[0].frame = 0;
    spawn(gx*16+8, gy*16+8, '#ff77bd');
  });
  function drawPreviewGrid(){
    const styles = getComputedStyle(document.documentElement);
    const even = styles.getPropertyValue('--grid-even');
    const odd = styles.getPropertyValue('--grid-odd');
    const border = styles.getPropertyValue('--border');
    for(let y=0;y<GRID;y++){
      for(let x=0;x<GRID;x++){
        pctx.fillStyle = (x+y)%2 ? even : odd;
        pctx.fillRect(x*16,y*16,16,16);
      }
    }
    pctx.strokeStyle = border;
    pctx.lineWidth = 1;
    pctx.strokeRect(0.5,0.5,PREVIEW_W-1,PREVIEW_H-1);
  }
  function drawPreviewCursor(c){
    const frames = [2,3,4,5];
    const r = frames[Math.floor(c.frame)%frames.length];
    const cx = c.x*16+8; const cy = c.y*16+8;
    pctx.strokeStyle = c.color; pctx.lineWidth = 1;
    pctx.beginPath(); pctx.arc(cx, cy, r, 0, Math.PI*2); pctx.stroke();
    pctx.beginPath(); pctx.arc(cx, cy, Math.max(1,r-2), 0, Math.PI*2); pctx.stroke();
  }
  function drawPreviewParticles(){
    for(let i=previewState.particles.length-1;i>=0;i--){
      const p = previewState.particles[i]; p.age++;
      p.x += p.vx; p.y += p.vy; p.vy += 0.02;
      const a = Math.max(0, 1 - p.age/p.life);
      if(p.age>p.life){ previewState.particles.splice(i,1); continue; }
      pctx.fillStyle = p.color; pctx.globalAlpha = a;
      pctx.fillRect(p.x-1,p.y-1,2,2);
      pctx.globalAlpha = 1;
    }
  }
  let fpsCounter=0, fpsLast=performance.now();
  let previewRAF=null, previewRunning=false;
  function previewFrame(){
    const now = performance.now(); fpsCounter++;
    if(now - fpsLast > 500){
      const fps = Math.round(fpsCounter*1000/(now-fpsLast));
      $('#fps').textContent = `FPS¬†${fps}`;
      fpsCounter=0; fpsLast = now;
    }
    previewState.t++;
    drawPreviewGrid();
    previewState.cursors.forEach(c => { c.frame += 0.25; drawPreviewCursor(c); });
    if(previewState.t % 12 === 0){
      previewState.cursors.forEach(c => spawn(c.x*16+8, c.y*16+8, c.color));
    }
    drawPreviewParticles();
    previewRAF = requestAnimationFrame(previewFrame);
  }
  function startPreview(){ if(previewRunning) return; previewRunning=true; previewFrame(); }
  function stopPreview(){ if(!previewRunning) return; previewRunning=false; if(previewRAF!==null){ cancelAnimationFrame(previewRAF); previewRAF=null; } }
  drawPreviewGrid(); startPreview();

  // –ê–≤–∞—Ç–∞—Ä—ã —Å —á–∞—Å—Ç—è–º–∏ –ª–∏—Ü–∞
  function px(ctx,x,y,s,color){ ctx.fillStyle=color; ctx.fillRect(x*s,y*s,s,s); }
  function drawHead(ctx,W,H,S,parts,dx,dy,eyeDx){
    const skin='#f4d7b5', eye='#10131e', mouth='#7a3b2a';
    ctx.clearRect(0,0,W*S,H*S);
    // —à–µ—è/—Ç–µ–ª–æ
    const shirt='#2a2f54';
    px(ctx,7+dx,12+dy,S,shirt); px(ctx,8+dx,12+dy,S,shirt);
    px(ctx,7+dx,11+dy,S,shirt); px(ctx,8+dx,11+dy,S,shirt);
    // –≥–æ–ª–æ–≤–∞
    for(let i=5;i<=10;i++) px(ctx,i+dx,7+dy,S,skin);
    for(let i=6;i<=9;i++) px(ctx,i+dx,6+dy,S,skin);
    px(ctx,6+dx,8+dy,S,skin); px(ctx,9+dx,8+dy,S,skin);
    // —Ä–æ—Ç
    if(parts.mouth===0){ px(ctx,7+dx,9+dy,S,mouth); px(ctx,8+dx,9+dy,S,mouth); }
    if(parts.mouth===1){ px(ctx,7+dx,9+dy,S,mouth); }
    if(parts.mouth===2){ px(ctx,7+dx,9+dy,S,mouth); px(ctx,8+dx,9+dy,S,mouth); px(ctx,7+dx,10+dy,S,mouth); px(ctx,8+dx,10+dy,S,mouth); }
    if(parts.mouth===3){ px(ctx,7+dx,10+dy,S,mouth); px(ctx,8+dx,10+dy,S,mouth); }
    // –≥–ª–∞–∑–∞
    if(parts.eyes===0){ px(ctx,6+dx+eyeDx,7+dy,S,eye); px(ctx,9+dx+eyeDx,7+dy,S,eye); }
    if(parts.eyes===1){ px(ctx,6+dx+eyeDx,7+dy,S,eye); }
    if(parts.eyes===2){ px(ctx,6+dx+eyeDx,7+dy,S,eye); px(ctx,9+dx+eyeDx,7+dy,S,eye); px(ctx,7+dx,7+dy,S,eye); }
    if(parts.eyes===3){ px(ctx,6+dx+eyeDx,7+dy,S,eye); px(ctx,6+dx+eyeDx,8+dy,S,eye); px(ctx,9+dx+eyeDx,7+dy,S,eye); px(ctx,9+dx+eyeDx,8+dy,S,eye); }
    // –≤–æ–ª–æ—Å—ã
    const hair = hairPalette[parts.hairColor%hairPalette.length];
    if(parts.hairStyle===0){ for(let i=5;i<=10;i++) px(ctx,i+dx,5+dy,S,hair); px(ctx,5+dx,6+dy,S,hair); px(ctx,10+dx,6+dy,S,hair); }
    if(parts.hairStyle===1){ for(let i=5;i<=10;i++) px(ctx,i+dx,5+dy,S,hair); px(ctx,5+dx,6+dy,S,hair); px(ctx,6+dx,6+dy,S,hair); }
    if(parts.hairStyle===2){ for(let i=6;i<=9;i++) px(ctx,i+dx,5+dy,S,hair); px(ctx,5+dx,6+dy,S,hair); px(ctx,10+dx,6+dy,S,hair); }
    if(parts.hairStyle===3){ for(let i=5;i<=10;i++) px(ctx,i+dx,5+dy,S,hair); px(ctx,7+dx,4+dy,S,hair); }
    if(parts.hairStyle===4){ for(let i=5;i<=10;i++) px(ctx,i+dx,5+dy,S,hair); px(ctx,5+dx,6+dy,S,hair); px(ctx,5+dx,7+dy,S,hair); }
    if(parts.hairStyle===5){ for(let i=5;i<=10;i++) px(ctx,i+dx,5+dy,S,hair); px(ctx,5+dx,6+dy,S,hair); px(ctx,10+dx,6+dy,S,hair); px(ctx,5+dx,7+dy,S,hair); px(ctx,10+dx,7+dy,S,hair); }
    ctx.globalAlpha=.12; ctx.fillStyle='#000'; ctx.fillRect(0,(dy?S:0),W*S,2*S); ctx.globalAlpha=1;
  }
  function makeAvatar(canvas, parts){
    const ac = canvas.getContext('2d'); ac.imageSmoothingEnabled=false;
    const W=16,H=16,S=4; let pointer=0; let tick=0; let cur={...parts};
    function onMove(e){ if(!settings.vfx){ pointer=0; return; } const r=canvas.getBoundingClientRect(); const sx=(e.clientX-r.left)/r.width-0.5; pointer=Math.max(-1,Math.min(1,Math.round(sx*2))); }
    canvas.addEventListener('pointermove', onMove);
    function step(){ tick++; const eyeDx=settings.vfx?Math.max(-1,Math.min(1,Math.round(Math.sin(tick/40))+pointer)):0; drawHead(ac,W,H,S,cur,0,0,eyeDx); requestAnimationFrame(step); }
    step();
    return { setParts(p){ cur={...cur,...p}; }, destroy(){ canvas.removeEventListener('pointermove', onMove); } };
  }
  const hairPalette = ['#ff5ca8','#68c7ff','#ffd166','#7aff9e','#c29eff','#ff8c42'];
  const avatar1 = makeAvatar($('#avatar1'), {hairStyle:0,eyes:0,mouth:0,hairColor:0});
  const avatar2 = makeAvatar($('#avatar2'), {hairStyle:0,eyes:0,mouth:0,hairColor:1});

  /*
    –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏–≥—Ä.  –ß—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞
    –Ω–∞–ø—Ä—è–º—É—é (file://) –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞, –º—ã –¥—É–±–ª–∏—Ä—É–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –º–æ–¥—É–ª–µ–π
    Pong –∏ Runner –ø—Ä—è–º–æ –∑–¥–µ—Å—å.  –ö–æ–≥–¥–∞ —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ HTTP, —ç—Ç–∏
    –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –Ω–µ –Ω—É–∂–Ω—ã ‚Äî —Ö–∞–± –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—ã –∏–∑
    –∫–∞—Ç–∞–ª–æ–≥–∞ games/<slug>/module.js –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö.  –ù–æ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞
    —á–µ—Ä–µ–∑ <script src> –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å –Ω–µ—É–¥–∞—á–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞
    –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ file://), –≤—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–ø–∞—Å–∞—é—Ç.
  */
  const games = {
    pong: {
      manifest: { slug:'pong', name:'Pong', caption:'–ö–ª–∞—Å—Å–∏–∫–∞ 1v1', icon:'üèì', version:'1.0.0', players:2 },
      async mount(root, context) {
        // —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞ games/pong/module.js
        const container = document.createElement('div');
        container.className = 'game-pong';
        container.style.position = 'relative';
        container.style.width = '100%';
        container.style.height = '100%';
        root.innerHTML = '';
        root.appendChild(container);
        const canvas = document.createElement('canvas');
        canvas.width = 160;
        canvas.height = 100;
        canvas.className = 'pixel';
        canvas.style.width = canvas.width + 'px';
        canvas.style.height = canvas.height + 'px';
        container.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        const ro = new ResizeObserver(()=>{
          const w = container.clientWidth, h = container.clientHeight;
          const scale = Math.max(1, Math.floor(Math.min(w/canvas.width, h/canvas.height)));
          canvas.style.width = canvas.width*scale+'px';
          canvas.style.height = canvas.height*scale+'px';
        });
        ro.observe(container);
        const scoreEl = document.createElement('div');
        scoreEl.style.position = 'absolute';
        scoreEl.style.top = '6px';
        scoreEl.style.left = '50%';
        scoreEl.style.transform = 'translateX(-50%)';
        scoreEl.style.color = getComputedStyle(document.documentElement).getPropertyValue('--ink');
        scoreEl.style.font = '14px ui-monospace';
        scoreEl.style.userSelect = 'none';
        container.appendChild(scoreEl);
        const backCv=document.createElement('canvas');
        backCv.className='pixel'; backCv.width=64; backCv.height=16;
        backCv.style.position='absolute'; backCv.style.bottom='8px'; backCv.style.left='8px';
        container.appendChild(backCv);
        makeCanvasButton(backCv,{label:'–ù–∞–∑–∞–¥',onClick(){ location.hash=''; }});
        const width = canvas.width;
        const height = canvas.height;
        const paddleW = 2;
        const paddleH = 16;
        const ballSize = 2;
        let p1 = { y: height/2 - paddleH/2, score: 0 };
        let p2 = { y: height/2 - paddleH/2, score: 0 };
        let ball = { x: width/2, y: height/2, vx: 1.8, vy: 1.2 };
        let running = true;
        let pointerY = null;
        const keys = {};
        function onPointer(e){ e.preventDefault(); const rect=canvas.getBoundingClientRect(); const sy=(e.clientY-rect.top)/rect.height; pointerY = sy*height; }
        canvas.addEventListener('pointermove', onPointer, {passive:false});
        canvas.addEventListener('pointerdown', onPointer, {passive:false});
        function onKeyDown(e){ keys[e.key.toLowerCase()] = true; }
        function onKeyUp(e){ keys[e.key.toLowerCase()] = false; }
        window.addEventListener('keydown', onKeyDown);
        window.addEventListener('keyup', onKeyUp);
        function resetBall(){ ball.x = width/2; ball.y = height/2; ball.vx = (Math.random()>0.5?1:-1)*1.8; ball.vy = (Math.random()-0.5)*2; }
        function update(){
          if(pointerY !== null){ const target = pointerY - paddleH/2; p1.y += (target - p1.y)*0.2; }
          else{ if(keys['w']) p1.y -= 2; if(keys['s']) p1.y += 2; }
          if(keys['arrowup'] || keys['arrowdown']){ if(keys['arrowup']) p2.y -= 2; if(keys['arrowdown']) p2.y += 2; }
          else{ const target = ball.y - paddleH/2; p2.y += (target - p2.y)*0.05; }
          p1.y = Math.max(0, Math.min(height - paddleH, p1.y)); p2.y = Math.max(0, Math.min(height - paddleH, p2.y));
          ball.x += ball.vx; ball.y += ball.vy;
          if(ball.y <= 0 || ball.y >= height - ballSize){ ball.vy *= -1; ball.y = Math.max(0, Math.min(height-ballSize, ball.y)); }
          if(ball.x <= paddleW && ball.y + ballSize > p1.y && ball.y < p1.y + paddleH){ ball.vx = Math.abs(ball.vx); const impact=(ball.y+ballSize/2-(p1.y+paddleH/2))/(paddleH/2); ball.vy = impact*1.5; }
          if(ball.x + ballSize >= width - paddleW && ball.y + ballSize > p2.y && ball.y < p2.y + paddleH){ ball.vx = -Math.abs(ball.vx); const impact=(ball.y+ballSize/2-(p2.y+paddleH/2))/(paddleH/2); ball.vy = impact*1.5; }
          if(ball.x < -ballSize){ p2.score++; resetBall(); }
          if(ball.x > width + ballSize){ p1.score++; resetBall(); }
        }
        function render(){
          const styles = getComputedStyle(document.documentElement);
          const odd = styles.getPropertyValue('--grid-odd').trim();
          const even = styles.getPropertyValue('--grid-even').trim();
          const highlight = styles.getPropertyValue('--highlight');
          for(let y=0; y<height; y+=16){ for(let x=0; x<width; x+=16){ ctx.fillStyle = ((x+y)/16 % 2 === 0) ? odd : even; ctx.fillRect(x,y,16,16); } }
          ctx.fillStyle = highlight; for(let y=0;y<height;y+=6) ctx.fillRect(width/2-1,y,2,3);
          ctx.fillStyle = '#ff77bd'; ctx.fillRect(0,p1.y,paddleW,paddleH);
          ctx.fillStyle = '#68c7ff'; ctx.fillRect(width-paddleW,p2.y,paddleW,paddleH);
          ctx.fillStyle = '#ffd166'; ctx.fillRect(ball.x, ball.y, ballSize, ballSize);
          scoreEl.textContent = `${p1.score} : ${p2.score}`;
        }
        let animId;
        function loop(){ update(); render(); animId = requestAnimationFrame(loop); }
        loop();
        return { unmount(){ cancelAnimationFrame(animId); canvas.removeEventListener('pointermove', onPointer); canvas.removeEventListener('pointerdown', onPointer); window.removeEventListener('keydown', onKeyDown); window.removeEventListener('keyup', onKeyUp); ro.disconnect(); if(container.parentNode===root) root.removeChild(container); } };
      }
    },
    runner: {
      manifest: { slug:'runner', name:'Runner', caption:'–ü—Ä—ã–≥–∞–π –∏ –±–µ–≥–∏', icon:'üèÉ', version:'1.0.0', players:1 },
      async mount(root, context){
        const container = document.createElement('div');
        container.className = 'game-runner'; container.style.position = 'relative'; container.style.width='100%'; container.style.height='100%'; root.innerHTML=''; root.appendChild(container);
        const canvas = document.createElement('canvas'); canvas.width=160; canvas.height=90; canvas.className='pixel'; canvas.style.width=canvas.width+'px'; canvas.style.height=canvas.height+'px'; container.appendChild(canvas);
        const ctx = canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
        const ro = new ResizeObserver(()=>{ const w=container.clientWidth,h=container.clientHeight; const scale=Math.max(1,Math.floor(Math.min(w/canvas.width,h/canvas.height))); canvas.style.width=canvas.width*scale+'px'; canvas.style.height=canvas.height*scale+'px'; }); ro.observe(container);
        const scoreEl = document.createElement('div'); scoreEl.style.position='absolute'; scoreEl.style.top='6px'; scoreEl.style.left='8px'; scoreEl.style.color=getComputedStyle(document.documentElement).getPropertyValue('--ink'); scoreEl.style.font='14px ui-monospace'; scoreEl.style.userSelect='none'; container.appendChild(scoreEl);
        const backCv=document.createElement('canvas'); backCv.className='pixel'; backCv.width=64; backCv.height=16; backCv.style.position='absolute'; backCv.style.bottom='8px'; backCv.style.left='8px'; container.appendChild(backCv); makeCanvasButton(backCv,{label:'–ù–∞–∑–∞–¥',onClick(){ location.hash=''; }});
        const width = canvas.width; const height = canvas.height; const groundY = height - 10; const gravity=0.2;
        const player = { x:20, y: groundY - 8, vy:0, w:8, h:8, jumping:false };
        let obstacles = []; let spawnTimer=0; let score=0; let running=true; let gameOver=false;
        function resetGame(){ player.y=groundY-player.h; player.vy=0; player.jumping=false; obstacles=[]; spawnTimer=0; score=0; gameOver=false; running=true; }
        function jump(){ if(!player.jumping && !gameOver){ player.vy = -4.2; player.jumping = true; } if(gameOver){ resetGame(); } }
        function onPointer(e){ e.preventDefault(); jump(); }
        function onKey(e){ if(e.key === ' '){ e.preventDefault(); jump(); } }
        canvas.addEventListener('pointerdown', onPointer, {passive:false});
        window.addEventListener('keydown', onKey);
        function update(){ if(!running) return; player.vy += gravity; player.y += player.vy; if(player.y >= groundY-player.h){ player.y = groundY-player.h; player.vy=0; player.jumping=false; } spawnTimer--; if(spawnTimer <= 0){ const obsH = 12 + Math.floor(Math.random()*10); obstacles.push({ x: width, y: groundY - obsH, w:6, h:obsH }); spawnTimer = 80 + Math.random()*60; } for(let i=obstacles.length-1; i>=0; i--){ const o=obstacles[i]; o.x -= 1.8; if(!gameOver && o.x < player.x + player.w && o.x + o.w > player.x && o.y < player.y + player.h && o.y + o.h > player.y){ gameOver = true; running=false; if(score>best){ best=score; context && context.store && context.store.set('games.runner.best', best); } } if(o.x + o.w < 0){ obstacles.splice(i,1); if(!gameOver) score++; } } }
        function drawPlayer(){ const px=(x,y,s,c)=>{ ctx.fillStyle=c; ctx.fillRect(x*s,y*s,s,s); }; const s=1; const offX=Math.floor(player.x); const offY=Math.floor(player.y); // —Ç–µ–ª–æ
          px(offX+1, offY+3, s, '#ff77bd'); px(offX+2, offY+3, s, '#ff77bd'); px(offX+1, offY+4, s, '#ff77bd'); px(offX+2, offY+4, s, '#ff77bd'); px(offX+1, offY+5, s, '#ff77bd'); px(offX+2, offY+5, s, '#ff77bd'); // –≥–æ–ª–æ–≤–∞
          px(offX+1, offY+1, s, '#ffd166'); px(offX+2, offY+1, s, '#ffd166'); px(offX+1, offY+2, s, '#ffd166'); px(offX+2, offY+2, s, '#ffd166'); // –≥–ª–∞–∑–∞
          px(offX+1, offY+2, s, '#10131e'); px(offX+2, offY+2, s, '#10131e'); }
        function render(){ const styles=getComputedStyle(document.documentElement); const odd=styles.getPropertyValue('--grid-odd').trim(); const even=styles.getPropertyValue('--grid-even').trim(); const highlight=styles.getPropertyValue('--highlight'); for(let y=0;y<height;y+=16){ for(let x=0;x<width;x+=16){ ctx.fillStyle = ((x+y)/16 % 2 === 0) ? odd : even; ctx.fillRect(x,y,16,16); } } ctx.fillStyle=highlight; ctx.fillRect(0, groundY, width, 1); drawPlayer(); ctx.fillStyle='#ff6b6b'; obstacles.forEach(o => ctx.fillRect(o.x, o.y, o.w, o.h)); scoreEl.textContent = gameOver ? `Game¬†Over ‚Äî —Å—á–µ—Ç: ${score} (–ª—É—á—à–∏–π: ${best})` : `–û—á–∫–∏: ${score}`; }
        let animId; let best = context && context.store ? context.store.get('games.runner.best',0) : 0; function loop(){ update(); render(); animId = requestAnimationFrame(loop); } loop();
        return { unmount(){ running=false; cancelAnimationFrame(animId); canvas.removeEventListener('pointerdown', onPointer); window.removeEventListener('keydown', onKey); ro.disconnect(); if(container.parentNode===root) root.removeChild(container); } };
      }
    }
  };

  // –†–æ—É—Ç–∏–Ω–≥: –∑–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è –ø–æ —Ö—ç—à—É –±–µ–∑ dynamic import
  let currentGame = null;
  async function loadGameModule(slug) {
    // –ï—Å–ª–∏ –º–æ–¥—É–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
    if(window.__DeepFlyGames && window.__DeepFlyGames[slug]) {
      return window.__DeepFlyGames[slug];
    }
    // –ò–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º —Ç–µ–≥ script –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –∏–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã (file://), –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–∑–≤–æ–ª–∏—Ç
    // –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Å–æ—Å–µ–¥–Ω–∏–µ .js —Ñ–∞–π–ª—ã –∫–∞–∫ —Å–∫—Ä–∏–ø—Ç—ã.  –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Å—Ä–∞–∑—É
    // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∏–≥—Ä—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å.
    if (location.protocol === 'file:' && games && games[slug]) {
      return games[slug];
    }
    return new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = `./games/${slug}/module.js`;
      // –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –º–æ–¥—É–ª—å
      script.onload = () => {
        if (window.__DeepFlyGames && window.__DeepFlyGames[slug]) {
          resolve(window.__DeepFlyGames[slug]);
        } else if (games && games[slug]) {
          // –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –º–æ–¥—É–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è: –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∏–≥—Ä—É
          resolve(games[slug]);
        } else {
          // –ù–µ—Ç –Ω–∏ –≤–Ω–µ—à–Ω–µ–≥–æ, –Ω–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è
          reject(new Error(`–ú–æ–¥—É–ª—å ${slug} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω`));
        }
      };
      // –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
      script.onerror = () => {
        // –£–¥–∞–ª—è–µ–º —Ç–µ–≥, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å head
        if (script.parentNode) script.parentNode.removeChild(script);
        if (games && games[slug]) {
          resolve(games[slug]);
        } else {
          reject(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª games/${slug}/module.js`));
        }
      };
      document.head.appendChild(script);
    });
  }
  async function loadFromHash(){
    const m = location.hash.match(/game=([\w-]+)/);
    if(!m){
      if(currentGame && currentGame.unmount) currentGame.unmount();
      currentGame = null;
      $('#preview').style.display='block';
      $('#vmenu').style.display='grid';
      startPreview();
      const firstCard = $('#vmenu .vcard'); if(firstCard) firstCard.focus();
      return;
    }
    const slug = m[1];
    try {
      let mod;
      // –í—Å–µ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –∏–≥—Ä—É.  –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç
      // —Ä–∞–±–æ—Ç—É –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã, –≥–¥–µ –∑–∞–≥—Ä—É–∑–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö
      // –º–æ–¥—É–ª–µ–π –∑–∞–ø—Ä–µ—â–µ–Ω–∞.  –ï—Å–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–µ—Ç, –ø—ã—Ç–∞–µ–º—Å—è
      // –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥—É–ª—å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ games/<slug>/.
      if (games && games[slug]) {
        mod = games[slug];
      } else {
        mod = await loadGameModule(slug);
      }
      if(currentGame && currentGame.unmount) currentGame.unmount();
      currentGame = await mod.mount($('#scenePanel'), getContext());
      stopPreview();
      $('#preview').style.display='none';
      $('#vmenu').style.display='none';
    } catch(err) {
      flash(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É ¬´${slug}¬ª. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ games/${slug}/module.js —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.`);
      if(currentGame && currentGame.unmount) currentGame.unmount();
      currentGame = null;
      $('#preview').style.display='block';
      $('#vmenu').style.display='grid';
      startPreview();
      const firstCard = $('#vmenu .vcard'); if(firstCard) firstCard.focus();
    }
  }
  window.addEventListener('hashchange', loadFromHash);
  loadFromHash();
  
  // –ö–æ–Ω—Ç–µ–∫—Å—Ç, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã–π –≤ –∏–≥—Ä—ã
  function getContext(){
    return {
      version: HUB_VERSION,
      bus,
      theme,
      store,
      ui:{ flash },
      input: {
        // —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –≤–≤–æ–¥: –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–ª–∞–≤–∏—à–∏
        on(type, handler){ window.addEventListener(type, handler); },
        off(type, handler){ window.removeEventListener(type, handler); }
      },
      net:{ rest: async ()=>{ throw new Error('REST –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω'); }, rt:{ connect:()=>({ publish(){}, subscribe(){}, close(){} }) } },
      root: $('#scenePanel')
    };
  }

  // –ü—Ä–æ—Ñ–∏–ª—å
  let profile = {
    id: store.get('profile.id', Date.now()),
    nickname: store.get('profile.nickname','–ò–≥—Ä–æ–∫'),
    avatar: store.get('profile.avatar',{hairStyle:0,eyes:0,mouth:0,hairColor:0})
  };
  store.set('profile.id', profile.id);
  $('#playerName').textContent = profile.nickname;
  avatar1.setParts(profile.avatar);
  avatar2.setParts(profile.avatar);
  const avatarEdit = makeAvatar($('#avatarEdit'), profile.avatar);

  let avatarDlg=null;
  function openAvatarPanel(opener){
    $('#nickInput').value = profile.nickname;
    avatarEdit.setParts(profile.avatar);
    avatarDlg = openDialog('#avatarDialog', opener);
  }
  const clamp=(v,min,max)=>(v<min?max:(v>max?min:v));
  const HAIR_STYLES=6, EYE_STYLES=4, MOUTH_STYLES=4;
  makeCanvasButton($('#hairPrev'),{label:'‚óÄ',onClick(){ profile.avatar.hairStyle = clamp(profile.avatar.hairStyle-1,0,HAIR_STYLES-1); avatarEdit.setParts(profile.avatar); }});
  $('#hairPrev').setAttribute('aria-label','–ü—Ä–µ–¥—ã–¥—É—â–∞—è –ø—Ä–∏—á–µ—Å–∫–∞');
  makeCanvasButton($('#hairNext'),{label:'‚ñ∂',onClick(){ profile.avatar.hairStyle = clamp(profile.avatar.hairStyle+1,0,HAIR_STYLES-1); avatarEdit.setParts(profile.avatar); }});
  $('#hairNext').setAttribute('aria-label','–°–ª–µ–¥—É—é—â–∞—è –ø—Ä–∏—á–µ—Å–∫–∞');
  makeCanvasButton($('#eyesPrev'),{label:'‚óÄ',onClick(){ profile.avatar.eyes = clamp(profile.avatar.eyes-1,0,EYE_STYLES-1); avatarEdit.setParts(profile.avatar); }});
  $('#eyesPrev').setAttribute('aria-label','–ü—Ä–µ–¥—ã–¥—É—â–∏–µ –≥–ª–∞–∑–∞');
  makeCanvasButton($('#eyesNext'),{label:'‚ñ∂',onClick(){ profile.avatar.eyes = clamp(profile.avatar.eyes+1,0,EYE_STYLES-1); avatarEdit.setParts(profile.avatar); }});
  $('#eyesNext').setAttribute('aria-label','–°–ª–µ–¥—É—é—â–∏–µ –≥–ª–∞–∑–∞');
  makeCanvasButton($('#mouthPrev'),{label:'‚óÄ',onClick(){ profile.avatar.mouth = clamp(profile.avatar.mouth-1,0,MOUTH_STYLES-1); avatarEdit.setParts(profile.avatar); }});
  $('#mouthPrev').setAttribute('aria-label','–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–æ—Ç');
  makeCanvasButton($('#mouthNext'),{label:'‚ñ∂',onClick(){ profile.avatar.mouth = clamp(profile.avatar.mouth+1,0,MOUTH_STYLES-1); avatarEdit.setParts(profile.avatar); }});
  $('#mouthNext').setAttribute('aria-label','–°–ª–µ–¥—É—é—â–∏–π —Ä–æ—Ç');
  makeCanvasButton($('#colorPrev'),{label:'‚óÄ',onClick(){ profile.avatar.hairColor = clamp(profile.avatar.hairColor-1,0,hairPalette.length-1); avatarEdit.setParts(profile.avatar); }});
  $('#colorPrev').setAttribute('aria-label','–ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ü–≤–µ—Ç');
  makeCanvasButton($('#colorNext'),{label:'‚ñ∂',onClick(){ profile.avatar.hairColor = clamp(profile.avatar.hairColor+1,0,hairPalette.length-1); avatarEdit.setParts(profile.avatar); }});
  $('#colorNext').setAttribute('aria-label','–°–ª–µ–¥—É—é—â–∏–π —Ü–≤–µ—Ç');
  function saveProfile(){
    profile.nickname = $('#nickInput').value.trim() || '–ò–≥—Ä–æ–∫';
    store.set('profile.nickname', profile.nickname);
    store.set('profile.avatar', profile.avatar);
    $('#playerName').textContent = profile.nickname;
    avatar1.setParts(profile.avatar);
    avatar2.setParts(profile.avatar);
  }
  makeCanvasButton($('#profileSave'),{label:'–ü—Ä–æ—Ñ–∏–ª—å',onClick(){ openAvatarPanel($('#profileSave')); }});
  makeCanvasButton($('#avatarSave'),{label:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',onClick(){ saveProfile(); avatarDlg && avatarDlg.close(); }});
  makeCanvasButton($('#avatarCancel'),{label:'–û—Ç–º–µ–Ω–∞',onClick(){ avatarDlg && avatarDlg.close(); }});
  makeCanvasButton($('#avatarClose'),{label:'√ó',onClick(){ avatarDlg && avatarDlg.close(); }});
  $('#avatarClose').setAttribute('aria-label','–ó–∞–∫—Ä—ã—Ç—å');
  makeCanvasButton($('#profileReset'),{label:'–°–±—Ä–æ—Å',onClick(){
    store.del('profile.nickname'); store.del('profile.avatar');
    profile = { id: profile.id, nickname:'–ò–≥—Ä–æ–∫', avatar:{hairStyle:0,eyes:0,mouth:0,hairColor:0} };
    $('#playerName').textContent = profile.nickname; avatar1.setParts(profile.avatar); avatar2.setParts(profile.avatar);
  }});
  makeCanvasButton($('#inviteBtn'),{label:'–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å',onClick(){}});
  makeCanvasButton($('#skinBtn'),{label:'–°–∫–∏–Ω',onClick(){ openAvatarPanel($('#skinBtn')); }});

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  settings.mute = store.get('settings.mute', false);
  settings.vfx = store.get('settings.vfx', true);
  settings.theme = store.get('settings.theme', 'dark');
  theme.apply(settings.theme);
  $('#muteToggle').checked = settings.mute;
  $('#vfxToggle').checked = settings.vfx;
  $('#themeAltToggle').checked = settings.theme==='alt';
  let settingsDlg=null;
  makeCanvasButton($('#settingsSave'),{label:'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',onClick(){
    settings.mute = $('#muteToggle').checked;
    settings.vfx = $('#vfxToggle').checked;
    settings.theme = $('#themeAltToggle').checked ? 'alt' : 'dark';
    store.set('settings.mute', settings.mute);
    store.set('settings.vfx', settings.vfx);
    store.set('settings.theme', settings.theme);
    theme.apply(settings.theme);
    settingsDlg && settingsDlg.close();
  }});
  makeCanvasButton($('#settingsCancel'),{label:'–û—Ç–º–µ–Ω–∞',onClick(){ settingsDlg && settingsDlg.close(); }});
  makeCanvasButton($('#settingsClose'),{label:'√ó',onClick(){ settingsDlg && settingsDlg.close(); }});
  $('#settingsClose').setAttribute('aria-label','–ó–∞–∫—Ä—ã—Ç—å');

  // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –º–µ–Ω—é –∏–≥—Ä
  function drawIcon(canvas, slug){
    const ctx=canvas.getContext('2d'); ctx.imageSmoothingEnabled=false;
    const W=32,H=32; const styles=getComputedStyle(document.documentElement);
    const even=styles.getPropertyValue('--grid-even').trim(); const odd=styles.getPropertyValue('--grid-odd').trim();
    for(let y=0;y<H;y+=8){ for(let x=0;x<W;x+=8){ ctx.fillStyle=((x+y)/8%2===0)?odd:even; ctx.fillRect(x,y,8,8);} }
    if(slug==='pong'){ ctx.fillStyle='#ff77bd'; ctx.fillRect(2,6,3,20); ctx.fillStyle='#68c7ff'; ctx.fillRect(27,6,3,20); ctx.fillStyle='#ffd166'; ctx.fillRect(15,15,2,2); }
    if(slug==='runner'){ ctx.fillStyle='#ff77bd'; ctx.fillRect(10,18,4,8); ctx.fillStyle='#ffd166'; ctx.fillRect(10,14,4,4); ctx.fillStyle='#ff6b6b'; ctx.fillRect(22,12,4,12); }
  }
  function buildVMenu(){
    const menu = $('#vmenu'); menu.innerHTML='';
    const slugs=['pong','runner'];
    slugs.forEach(slug=>{
      const man=(games[slug]&&games[slug].manifest)||{slug};
      const btn=document.createElement('button'); btn.role='listitem';
      btn.className='vcard'; btn.tabIndex=0; btn.dataset.slug=slug;
      const icon=document.createElement('canvas'); icon.className='pixel icon64'; icon.width=32; icon.height=32; drawIcon(icon,slug);
      const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<div class="title">${man.name||slug}</div><div class="caption">${man.caption||''}</div>`;
      btn.appendChild(icon); btn.appendChild(meta);
      btn.addEventListener('click',()=>{ location.hash=`game=${slug}`; });
      btn.addEventListener('keydown',e=>{
        if(e.key==='Enter'){ e.preventDefault(); location.hash=`game=${slug}`; }
        if(e.key==='ArrowDown'||e.key==='ArrowUp'){
          const cards=Array.from($('#vmenu').querySelectorAll('.vcard'));
          const idx=cards.indexOf(document.activeElement);
          if(e.key==='ArrowDown'){ const n=Math.min(cards.length-1,idx+1); cards[n]?.focus(); }
          if(e.key==='ArrowUp'){ const n=Math.max(0,idx-1); cards[n]?.focus(); }
          e.preventDefault();
        }
      });
      btn.addEventListener('focus',()=>{ btn.scrollIntoView({block:'nearest',inline:'nearest'}); });
      btn.setAttribute('aria-label', man.name||slug);
      menu.appendChild(btn);
    });
  }
  buildVMenu();

  // –ó–∞–≥–æ–ª–æ–≤–æ–∫
  makeCanvasButton($('#btnGames'),{label:'–ò–≥—Ä—ã',onClick(){ location.hash=''; }});
  makeCanvasButton($('#btnSettings'),{label:'–ù–∞—Å—Ç—Ä–æ–π–∫–∏',onClick(){ $('#muteToggle').checked = settings.mute; $('#vfxToggle').checked = settings.vfx; $('#themeAltToggle').checked = settings.theme==='alt'; settingsDlg = openDialog('#settingsDialog', $('#btnSettings')); }});
  makeCanvasButton($('#btnAvatar'),{label:'–ê–≤–∞—Ç–∞—Ä',onClick(){ openAvatarPanel($('#btnAvatar')); }});

  </script>
</body>
</html>
